<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Language Translator</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
</head>

<body>
  <header class="page-header">
    <div class="logo-section">
      <img src="images/logo.png" alt="Logo" class="site-logo"/>
      <h1 class="site-title">EnTel</h1>
    </div>
    <nav class="main-nav">
      <span id="username-display" class="username-display"></span>
      <button class="nav-btn" id="history-btn"><i class="fas fa-history"></i> History</button>
      <button class="nav-btn"><i class="fas fa-bookmark"></i> Saved</button>
      <button class="nav-btn" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Log Out</button>
    </nav>
  </header>

  <div class="container">
    <h1>Language Translator</h1>
    <div class="input-container">
      <textarea id="text-input" placeholder="Type in English..."></textarea>
      <button id="translate-btn">Translate</button>
    </div>

    <h3>Translated Sentence:</h3>
    <div class="output-container">
      <textarea id="translated-text" placeholder="Telugu translation..." readonly></textarea>
      <div class="action-btns">
        <button class="action-btn" id="copy-btn"><i class="fas fa-copy"></i></button>
        <button class="action-btn" id="bookmark-btn"><i class="fas fa-bookmark"></i></button>
      </div>
    </div>
  </div>

  <div id="history-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="close-history">&times;</span>
      <h2>Translation History</h2>
      <ul id="history-list"></ul>
    </div>
  </div>

  <script src="script.js"></script>
  <script>
    //function to be called when user clicks on translate button.
    function startTranslation() {

      // Get the text that the user entered
      const inputText = document.getElementById("text-input").value;

      // Split the input into multiple lines to get multiline output
      const inputLines = inputText.split('\n');
      const promises = [];

      // Loop through each line and send it to the backend for translation
      for (const line of inputLines) {
        if (line.trim() === '') {
          promises.push(Promise.resolve('')); // Skip empty lines
        } else {
          const data = { sentence: line };

          // Fetch request to send data to the backend for translation
          const promise = fetch('https://476a-34-55-101-151.ngrok-free.app/process', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          })
          // Get the translated sentence back from the server
          .then(response => response.json())
          .then(result => result.processed_sentence);

          promises.push(promise); // Add the promise to the list of promises
        }
      }

      // Wait for all translations to complete
      Promise.all(promises)
        .then(translatedLines => {

          const translatedText = translatedLines.join('\n');

          // Set the translated text to the output textarea
          document.getElementById('translated-text').value = translatedText;

          // If both original and translated texts are not empty, save them to the backend

          if (inputText.trim() && translatedText.trim()) {
            fetch('/save-translation', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                english: inputText,
                telugu: translatedText
              })
            }).catch(err => console.error('Error saving translation:', err)); 
          }
        })
        .catch(error => {
          console.error('Translation Error:', error); // Handle any errors that occur during the translation process
        });
    }

    document.addEventListener('DOMContentLoaded', () => {

      // When the page is loaded, add event listeners to buttons
      document.getElementById('translate-btn').addEventListener('click', startTranslation);

      // Copy translated text to clipboard when copy button is clicked
      document.getElementById('copy-btn').addEventListener('click', () => {
        const translatedText = document.getElementById('translated-text');
        translatedText.select();
        document.execCommand("copy"); 
      });

      // Log the translation when bookmark button is clicked
      document.getElementById('bookmark-btn').addEventListener('click', () => {
        console.log("Bookmarked: " + document.getElementById('translated-text').value);
      });

      // Fetch and display the current user's username when the page loads
      fetch('/current-user')
        .then(response => response.json())
        .then(data => {
          if (data.username) {
            document.getElementById('username-display').textContent = `Welcome, ${data.username}`;
          }
        })
        .catch(error => {
          console.error('Error fetching user info:', error);
        });

      // Log the user out when the logout button is clicked
      document.getElementById('logout-btn').addEventListener('click', () => {
        fetch('/logout', { method: 'POST' })
          .then(response => response.json())
          .then(data => {
            if (data.message === "Logged out successfully") {
              window.location.href = '/login'; 
            }
          })
          .catch(error => {
            console.error('Error logging out:', error);
          });
      });

      //handling of history
      document.getElementById('history-btn').addEventListener('click', () => {
        fetch('/history')
          .then(response => response.json())
          .then(data => {
            if (data.translations && data.translations.length > 0) {
              const historyList = document.getElementById('history-list');
              historyList.innerHTML = ''; // Clear previous history
              // Loop through each translation and display it in the history modal
              data.translations.forEach(translation => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `<strong>English:</strong> ${translation.english} <br> <strong>Telugu:</strong> ${translation.telugu}`;
                historyList.appendChild(listItem);
              });
        

              document.getElementById('history-modal').style.display = 'block';
            }
          })
          .catch(error => {
            console.error('Error fetching history:', error);
          });
      });

      // Close the history modal when the close button is clicked
      document.getElementById('close-history').addEventListener('click', () => {
        document.getElementById('history-modal').style.display = 'none';
      });

      // Close the modal if the user clicks outside of it
      window.addEventListener('click', (event) => {
        if (event.target === document.getElementById('history-modal')) {
          document.getElementById('history-modal').style.display = 'none';
        }
      });
    });
  </script>

</body>
</html>
