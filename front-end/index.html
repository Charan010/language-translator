<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Language Translator</title>
  <link rel="stylesheet" href="styles.css" />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
  />
</head>
<body>
  <header class="page-header">
    <div class="logo-section">
      <img src="images/logo.png" alt="Logo" class="site-logo" />
      <h1 class="site-title">EnTel</h1>
    </div>
    <nav class="main-nav">
      <!-- Username display here -->
      <span id="username-display" class="username-display">Loading...</span>
      <button class="nav-btn" id="history-btn">
        <i class="fas fa-history"></i> History
      </button>
      <button class="nav-btn">
        <i class="fas fa-bookmark"></i> Saved
      </button>
      <button class="nav-btn" id="logout-btn">
        <i class="fas fa-sign-out-alt"></i> Log Out
      </button>
    </nav>
  </header>

  <div class="container">
    <h1>Language Translator</h1>
    <div class="input-container">
      <textarea id="text-input" placeholder="Type in English..."></textarea>
      <button id="translate-btn">Translate</button>
    </div>

    <h3>Translated Sentence:</h3>
    <div class="output-container">
      <textarea
        id="translated-text"
        placeholder="Telugu translation..."
        readonly
      ></textarea>
      <div class="action-btns">
        <button class="action-btn" id="copy-btn">
          <i class="fas fa-copy"></i>
        </button>
        <button class="action-btn" id="bookmark-btn">
          <i class="fas fa-bookmark"></i>
        </button>
      </div>
    </div>
  </div>

  <div id="history-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="close-history">&times;</span>
      <h2>Translation History</h2>
      <ul id="history-list"></ul>
      <button id="delete-history-btn" class="action-btn">
        <i class="fas fa-trash-alt"></i> Delete History
      </button>
    </div>
  </div>

  <script src="script.js"></script>
  <script>
    function startTranslation() {
      const inputText = document.getElementById("text-input").value;
      const inputLines = inputText.split("\n");
      const promises = [];

      for (const line of inputLines) {
        if (line.trim() === "") {
          promises.push(Promise.resolve(""));
        } else {
          const data = { sentence: line };
          const promise = fetch(
            "https://5f70-35-187-158-72.ngrok-free.app/process",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            }
          )
            .then((response) => response.json())
            .then((result) => result.processed_sentence);

          promises.push(promise);
        }
      }

      Promise.all(promises)
        .then((translatedLines) => {
          const translatedText = translatedLines.join("\n");
          document.getElementById("translated-text").value = translatedText;

          if (inputText.trim() && translatedText.trim()) {
            fetch("/save-translation", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                english: inputText,
                telugu: translatedText,
              }),
            }).catch((err) =>
              console.error("Error saving translation:", err)
            );
          }
        })
        .catch((error) => {
          console.error("Translation Error:", error);
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
      document
        .getElementById("translate-btn")
        .addEventListener("click", startTranslation);

      document.getElementById("copy-btn").addEventListener("click", () => {
        const translatedText = document.getElementById("translated-text");
        translatedText.select();
        document.execCommand("copy");
      });

      document.getElementById("bookmark-btn").addEventListener("click", () => {
        console.log(
          "Bookmarked: " + document.getElementById("translated-text").value
        );
      });

      fetch("/current-user")
        .then((response) => response.json())
        .then((data) => {
          if (data.username) {
            document.getElementById(
              "username-display"
            ).textContent = `Hello, ${data.username}`;
          } else {
            document.getElementById(
              "username-display"
            ).textContent = "Hello, Guest";
          }
        })
        .catch((error) => {
          console.error("Error fetching user info:", error);
        });

      document.getElementById("logout-btn").addEventListener("click", () => {
        fetch("/logout", { method: "POST" })
          .then((response) => response.json())
          .then((data) => {
            if (data.message === "Logged out successfully") {
              window.location.href = "/login";
            }
          })
          .catch((error) => {
            console.error("Error logging out:", error);
          });
      });

      document.getElementById("history-btn").addEventListener("click", () => {
        fetch("/history")
          .then((response) => response.json())
          .then((data) => {
            if (data.translations && data.translations.length > 0) {
              const historyList = document.getElementById("history-list");
              historyList.innerHTML = "";

              data.translations.forEach((translation) => {
                const listItem = document.createElement("li");
                const englishText = Array.isArray(translation.english)
                  ? translation.english.join("<br>")
                  : translation.english.replace(/\n/g, "<br>");
                const teluguText = Array.isArray(translation.telugu)
                  ? translation.telugu.join("<br>")
                  : translation.telugu.replace(/\n/g, "<br>");

                listItem.innerHTML = `<strong>English:</strong> ${englishText} <br> <strong>Telugu:</strong> ${teluguText}`;
                historyList.appendChild(listItem);
              });

              document.getElementById("history-modal").style.display = "block";
            }
          })
          .catch((error) => {
            console.error("Error fetching history:", error);
          });
      });

      //delete history
      document.getElementById("delete-history-btn").addEventListener("click", () => {
        fetch("/delete-history", { method: "DELETE" })
          .then((response) => response.json())
          .then((data) => {
            if (data.message === "History deleted successfully") {
              document.getElementById("history-list").innerHTML = "";
              document.getElementById("history-modal").style.display = "none";
            }
          })
          .catch((error) => {
            console.error("Error deleting history:", error);
          });
      });

      document
        .getElementById("close-history")
        .addEventListener("click", () => {
          document.getElementById("history-modal").style.display = "none";
        });

      window.addEventListener("click", (event) => {
        if (event.target === document.getElementById("history-modal")) {
          document.getElementById("history-modal").style.display = "none";
        }
      });
    });
  </script>
</body>
</html>
